#!/bin/bash
#to be sourced in .bashrc

__WholeWord="Ww"
__Function="Func"
__Default="Dflt"
__Define="Define"

_do_the_grep() {
	#test existance of mandatory arg
	if [ -z "$3" ]; then
			echo "Usage (strict order!): g[i] <search expr> [<path> <exclude expr>]"
			return 1
	fi

	expr=""
	#test case sensitive
	if [ $1 -eq 1 ]; then
			grep_opt="-iHIrn --color=always"
	else
			grep_opt="-HIrn --color=always"
	fi

	case "$2" in
		*${__WholeWord}* )
			expr="\<$3\>"
			;;&

		*${__Function}* )
			# if expr not already defined, the we are not looking for whole words. see above
			if [ -z "$expr" ]; then
				expr="${3}[a-zA-Z0-9_]*[[:space:]]*("
			else
				expr="\<${3}[[:space:]]*("
			fi
			;;

		*${__Define}* )
			# if expr not already defined, the we are not looking for whole words. see above
			if [ -z "$expr" ]; then
				expr="^[[:space:]]*#[[:space:]]*define[[:space:]]\+[a-zA-Z]\?[a-zA-Z0-9_]*${3}[a-zA-Z0-9_]*"
			else
				expr="^[[:space:]]*#[[:space:]]*define[[:space:]]\+${3}\>"
			fi
			;;

		${__Default} )
			expr="$3"
			;;
		# this will prevent first case from working. Activate only for debug purpose
		#* )
		#	echo "Unknown variant $2. Check the script for errors !!"
		#	return 1
		#	;;
	esac

#test for path
    if [ -n "$4" ]; then
#		if we do this we can't handle exclude arg nicely
#		shift 3
#       dir="$*"
			case $4 in
				__find* )
					echo "find . -name ${4#__find}"
					# TODO: this does not work. for some reason... :|
					dir=`find . -name ${4#__find}` 
					dir=$( $(echo "find . -name ${4#__find}") )
					echo $dir ;;
				* )	dir="$4" ;;
			esac
    else
			dir="."
    fi

    exclude="\<tags\>\|\.orig\>\|\.rej\>\|[a-zA-Z0-9]~\|\.[ch]_\|\.[ch]pp_\|\.cc_\|\.svn\|/CVS/"
#test for exclude list
    if [ -n "$5" ]; then
        exclude=${exclude}"\|$5"
    fi

	if [ -n "$6" ]; then
		echo "Too many arguments. if u use globing then pass it as a single argument ( e.g. \"*.cpp\" )"
		return 1
	fi

#   echo "Search in: $dir" 1>&2
    echo "Excluding from search: $exclude" 1>&2
    echo "grep $grep_opt -e$expr $dir | grep -ve $exclude"
    grep $grep_opt -e"$expr" $dir | grep -ve "$exclude"
}

g() {
    _do_the_grep 0 "$__Default" "$@"
}
gw() {
    _do_the_grep 0 "$__WholeWord" "$@"
}
gf() {
    _do_the_grep 0 "$__Function" "$@"
}
gwf() {
    _do_the_grep 0 "$__WholeWord""$__Function" "$@"
}
gfw() {
    _do_the_grep 0 "$__WholeWord""$__Function" "$@"
}
gd() {
    _do_the_grep 0 "$__Define" "$@"
}
gwd() {
    _do_the_grep 0 "$__WholeWord""$__Define" "$@"
}
gdw() {
    _do_the_grep 0 "$__WholeWord""$__Define" "$@"
}

gi() {
    _do_the_grep 1 "$__Default" "$@"
}
gwi() {
    _do_the_grep 1 "$__WholeWord" "$@"
}
gfi() {
    _do_the_grep 1 "$__Function" "$@"
}
gwfi() {
    _do_the_grep 1 "$__WholeWord""$__Function" "$@"
}
gfwi() {
    _do_the_grep 1 "$__WholeWord""$__Function" "$@"
}
gdi() {
    _do_the_grep 1 "$__Define" "$@"
}
gwdi() {
    _do_the_grep 1 "$__WholeWord""$__Define" "$@"
}
gdwi() {
    _do_the_grep 1 "$__WholeWord""$__Define" "$@"
}
