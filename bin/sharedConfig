#!/usr/bin/env python

import sys
import os
import os.path
import shutil
import stat
import subprocess


g_verbose = False
g_quiet = False
g_exclude_filenames = ('~','.swp')
g_exclude_dirs = ('.git', '.ropeproject')
g_repo_dir = None
g_repo_only_files = []
g_homeDir = os.environ['HOME']


def walk_dirs(top_path, action, except_these_dirs=None, only_these_files=None, except_these_files=None):
    """
    Recursively walk directory, applying action on each name

    top_path:           path_to_search_into
    action:             callback_to_call_on_each_file
    except_these_dirs:  iteratable_except_these_dirs=None
    only_these_files:   tuple_only_these_file_endings=None
    except_these_files: tuple_except_these_file_endings=None
    """
    top_path = os.path.abspath(top_path)
    files = os.listdir(top_path)

    for name in files:
        name = os.path.join(top_path, name)
        try:
            details = os.stat(name)
        except OSError, why:
            sys.stderr.write(why.filename + ': ' + why.strerror +'\n')

        if stat.S_ISDIR(details.st_mode):
            if except_these_dirs and os.path.basename(name) in except_these_dirs:
                continue
            walk_dirs(name, action, except_these_dirs, only_these_files, except_these_files)
        elif stat.S_ISREG(details.st_mode):
            if only_these_files and not os.path.basename(name).endswith(only_these_files):
                continue
            elif except_these_files and os.path.basename(name).endswith(except_these_files):
                continue
            action(name)


def areHardLinked(f1, f2):
    try:
        f1Details = os.stat(f1)
        f2Details = os.stat(f2)
    except BaseException:
        return False
    return f1Details[stat.ST_INO] == f2Details[stat.ST_INO]


# src is the newer file in this case and we are diffing the old home dst to the new repo src
def diff(src):
    dst = os.path.join(g_homeDir, src[len(g_repo_dir)+1:])

    # don't diff independent files
    if src[len(g_repo_dir)+1:] in g_repo_only_files:
        return
    if g_verbose:
        sys.stderr.write("diffing: " + "diff " + "-wu " + dst + " " + src + '\n')
    if not g_quiet:
        subprocess.call(["diff", "-wu", dst, src])


def link(src):
    global g_quiet

    short_name = src[len(g_repo_dir)+1:]
    dst = os.path.join(g_homeDir, src[len(g_repo_dir)+1:])

    # src is marked to be excluded
    if short_name in g_repo_only_files:
        return

    if g_quiet:
        answer = 'y'
    else:
        subprocess.call(["diff", "-wu", dst, src])
        print "--> ", dst, " will become a hard link of: ", src
        answer = raw_input("     Are you sure? Link (y), reverse link (r), break the linkage (u), skip (n), yes to all (a) (y/r/u/n/a) ?")

    if answer == 'a':
        g_quiet = True
        answer = 'y'

    # replace homeDir file with file in repo
    if answer == 'y':
        if not os.path.exists(os.path.dirname(dst)):
            os.makedirs(os.path.dirname(dst))
        elif areHardLinked(src, dst):
            if not g_quiet: print "%s and %s are already linked" % (src, dst)
            return
        elif os.path.exists(dst):
            if os.path.exists(dst+".git.bak"): os.remove(dst+".git.bak")
            os.rename(dst, dst+".git.bak")
        # if it is a symlink, copy it as it is
        if os.path.islink(src):
            linkto = os.readlink(src)
            try:
                os.symlink(linkto, dst)
            except BaseException as e:
                if not g_quiet: print e
        else:
            os.link(src, dst)
    # replace repo file with file in homeDir
    elif answer == 'r':
        os.remove(src)
        os.link(dst, src)
    # undo the link, the homeDir file will remain as it is
    elif answer == 'u' and areHardLinked(src, dst):
        bak_name = dst + ".git.bak"
        try:
            shutil.copy2(dst, bak_name)
            os.remove(dst)
            shutil.copy2(bak_name, dst)
            os.remove(bak_name)
            # FIXME: if the copy fails
        except OSError:
            pass
        # mark this as independent file so we will not relink it next time
        g_repo_only_files.append(short_name)


def post_merge_relink(src):
    # if src has only one hard link count
    stat_details = os.stat(src)
    if stat_details.st_nlink == 1:
        link(src)


def load_independent(name='.repo_only_files'):
    # use something ordered here
    try:
        with open(os.path.join(g_repo_dir, name)) as f:
            for line in f:
                g_repo_only_files.append(line.strip())
    except:
        sys.stderr.write("Failed to open {} for reading\n".format(name))


def save_independent(savename='.repo_only_files'):
    global g_repo_only_files
    # truncate
    with open(os.path.join(g_repo_dir, savename), 'w') as f:
        for name in g_repo_only_files:
            f.write(name + "\n")


def print_usage(cmd_name):
    print """This scans through your repo files, finds the mathcing files in your home dir and hard links them
    to the files in the repo
Usage:
    {} [-v|--verbose] [-q|--quiet] command repo_path

    command:
        diff: show the diffs only
        link: scan and do the linking
        post-merge: link only files that have one link in the repo and are also present in the home dir.
"""


def main(av):
    global g_verbose, g_repo_dir, g_repo_only_files, g_quiet
    command = None
    path = None
    for arg in av:
        if arg == '-v' or arg == '--verbose':
            g_verbose = True
        elif arg == '-q' or arg == '--quiet':
            g_quiet = True
        elif not command:
            command = arg
        elif not g_repo_dir:
            g_repo_dir = os.path.abspath(arg)
        elif not path:
            path = os.path.join(g_repo_dir, arg)
    if not command:
        print "Provide a command"
        sys.exit(1)
    if not g_repo_dir:
        print "Provide configuration repo directory."
        sys.exit(1)
    if not path:
        path = g_repo_dir
    if g_quiet:
        g_verbose = False

    g_repo_only_files = []
    load_independent()
    details = os.stat(path)

    if command == 'diff':
        if stat.S_ISREG(details.st_mode):
            diff(path)
        else:
            walk_dirs(path, diff, except_these_dirs=g_exclude_dirs, except_these_files=g_exclude_filenames)
    elif command == 'link':
        if stat.S_ISREG(details.st_mode):
            link(path)
        else:
            walk_dirs(path, link, except_these_dirs=g_exclude_dirs, except_these_files=g_exclude_filenames)
        save_independent()
    elif command == 'post-merge':
        if stat.S_ISREG(details.st_mode):
            post_merge_relink(path)
        else:
            walk_dirs(path, post_merge_relink, except_these_dirs=g_exclude_dirs, except_these_files=g_exclude_filenames)
        save_independent()
    else:
        print "Unknown command:", command
        sys.exit(1)


if __name__ == "__main__":
    if '--help' in sys.argv:
        print_usage(sys.argv[0])
        sys.exit(0)
    main(sys.argv[1:])

